<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Generate WhatsApp Invitation</title>
  <style>
    /* Styling remains the same */
    body {
      font-family: Arial, sans-serif;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      background-color: #f0f8ff;
      margin: 0;
    }
    .container {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      width: 100%;
      max-width: 500px;
    }
    h1 {
      text-align: center;
      color: #333;
    }
    label {
      font-size: 14px;
      margin-bottom: 6px;
      display: block;
    }
    input, select, button {
      width: 100%;
      padding: 12px;
      margin-bottom: 15px;
      font-size: 16px;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    button {
      background-color: #25D366;
      color: white;
      cursor: pointer;
      font-weight: bold;
      border: none;
    }
    button:hover {
      background-color: #128C7E;
    }
    .output {
      margin-top: 20px;
      padding: 10px;
      background-color: #f7f7f7;
      border-radius: 6px;
      font-size: 14px;
      color: #333;
    }
    .link {
      color: #0078ff;
      text-decoration: none;
    }
    .log-table {
      margin-top: 20px;
      width: 100%;
      border-collapse: collapse;
    }
    .log-table th, .log-table td {
      padding: 8px;
      text-align: left;
      border: 1px solid #ccc;
    }
    .log-table th {
      background-color: #f0f0f0;
    }
  </style>
</head>
<body>

  <div class="container">
    <h1>Generate WhatsApp Invitation</h1>
    
    <label for="guestName">Nama Tamu:</label>
    <input type="text" id="guestName" placeholder="Masukkan nama tamu" />

    <label for="phoneNumber">Nomor WhatsApp (tanpa + atau spasi):</label>
    <input type="text" id="phoneNumber" placeholder="Masukkan nomor tujuan" />

    <label for="isPartner">Apakah datang bersama pasangan?</label>
    <select id="isPartner">
      <option value="false">Tidak</option>
      <option value="true">Ya</option>
    </select>

    <label for="customLink">URL Undangan (Opsional):</label>
    <input type="text" id="customLink" placeholder="Masukkan link custom atau biarkan kosong" />
    
    
    <button id="generateButton">Generate Link & Pesan</button>

    <div class="output" id="output">
      <p>Link WhatsApp yang bisa dibagikan:</p>
      <a id="whatsAppLink" href="#" class="link" target="_blank">Klik di sini untuk membuka WhatsApp</a>
    </div>

    <!-- Tabel untuk menampilkan log -->
    <h2>Log Undangan WhatsApp</h2>
    <table class="log-table" id="logTable">
      <thead>
        <tr>
          <th>Nama Tamu</th>
          <th>Nomor WhatsApp</th>
          <th>Pasangan</th>
          <th>Link</th>
        </tr>
      </thead>
      <tbody id="logBody">
        <!-- Data log akan ditampilkan di sini -->
      </tbody>
    </table>
  </div>

  <script type="module">
  // Mengimpor Supabase SDK dari CDN
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

  // Ganti dengan URL Supabase dan anon key kamu
  const supabaseUrl = 'https://njdnhhbjdhtqaylhrxzv.supabase.co';  // Ganti dengan URL Supabase kamu
  const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5qZG5oaGJqZGh0cWF5bGhyeHp2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3NjM5NzMsImV4cCI6MjA3NjMzOTk3M30.PnlGDPgr7fCEmEDJrYac9mLM5_9GkRJp_6nxQ4C61tU'; // Ganti dengan anon key Supabase-mu // Ganti dengan anon key Supabase kamu
  const supabase = createClient(supabaseUrl, supabaseKey);

  // Fungsi untuk menghasilkan link WhatsApp dan pesan
  async function generateLink() {
    const guestName = document.getElementById('guestName').value.trim();
    const phoneNumber = document.getElementById('phoneNumber').value.trim();
    const isPartner = document.getElementById('isPartner').value === "true"; // Menangani pilihan partner
    const customLink = document.getElementById('customLink').value.trim() || 'https://weddingbridepakarif.vercel.app'; // Gunakan link default jika kosong

    // Validasi input
    if (!guestName || !phoneNumber) {
      alert("Mohon masukkan nama tamu dan nomor tujuan.");
      return;
    }

    // Format nama tamu dan pasangan
    const formattedName = guestName.split(" ")
      .map(word => word.charAt(0).toUpperCase() + word.slice(1))
      .join(" ");

    const displayName = isPartner ? `${formattedName} & Partner` : formattedName;

    // Template pesan untuk WhatsApp
    const message = `Kepada Yth.\nBapak/Ibu/Saudara/i\n${displayName}\n\nTanpa mengurangi rasa hormat, perkenankan kami mengundang Bapak/Ibu/Saudara/i, teman sekaligus sahabat, untuk menghadiri acara pernikahan kami.\n\nBerikut link undangan kami, untuk info lengkap dari acara, bisa kunjungi :\n\n${customLink}?guest_name=${encodeURIComponent(displayName)}\n\nMerupakan suatu kebahagiaan bagi kami apabila Bapak/Ibu/Saudara/i berkenan untuk hadir dan memberikan doa restu.\n\nTerima Kasih\n\nHormat kami,\nAsri & Arief`;

    // Membuat URL WhatsApp dengan parameter
    const whatsappURL = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`;

    // Menampilkan link WhatsApp di halaman
    const linkElement = document.getElementById('whatsAppLink');
    linkElement.href = whatsappURL;
    linkElement.textContent = 'Klik di sini untuk membuka WhatsApp';

    // Menambahkan data log ke Supabase
    const { data, error } = await supabase
      .from('whatsapp_invites')  // Pastikan sudah membuat table 'whatsapp_invites' di Supabase
      .insert([
        { guest_name: displayName, phone_number: phoneNumber, partner: isPartner, message_link: whatsappURL }
      ]);

    if (error) {
      console.error("Error inserting data: ", error);
    } else {
      console.log("Data log berhasil disimpan ke Supabase:", data);
      // Update tabel log di website setelah data berhasil disimpan
      updateLogTable();
    }

    // Menambahkan alert setelah link berhasil dibuat
    alert("Link WhatsApp berhasil dibuat! Silakan klik untuk membagikan undangan.");
  }

  // Fungsi untuk memperbarui log dari Supabase
  async function updateLogTable() {
    const { data, error } = await supabase
      .from('whatsapp_invites')  // Mengambil data log dari Supabase
      .select('*')
      .order('id', { ascending: false });

    if (error) {
      console.error("Error fetching data: ", error);
      return;
    }

    const logTableBody = document.getElementById('logBody');
    logTableBody.innerHTML = ''; // Clear existing rows

    // Menampilkan setiap baris log di tabel
    data.forEach(log => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${log.guest_name}</td>
        <td>${log.phone_number}</td>
        <td>${log.partner ? 'Ya' : 'Tidak'}</td>
        <td><a href="${log.message_link}" target="_blank">Lihat Link</a></td>
      `;
      logTableBody.appendChild(row);
    });
  }

  // Event listener untuk tombol generate
  document.getElementById('generateButton').addEventListener('click', function(event) {
    generateLink();
  });

  // Memperbarui tabel log saat halaman pertama kali dimuat
  window.onload = updateLogTable;
</script>

  
</body>
</html>
